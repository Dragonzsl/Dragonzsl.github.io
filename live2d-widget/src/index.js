import Model from"./model.js";import showMessage from"./message.js";import randomSelection from"./utils.js";import tools from"./tools.js";function loadWidget(i){const s=new Model(i);localStorage.removeItem("waifu-display");sessionStorage.removeItem("waifu-text");document.body.insertAdjacentHTML("beforeend",`<div id="waifu">
            <div id="waifu-tips"></div>
            <canvas id="live2d" width="800" height="800"></canvas>
            <div id="waifu-tool"></div>
        </div>`);setTimeout(()=>{document.getElementById("waifu").style.bottom=0},0);(function e(){tools["switch-model"].callback=()=>s.loadOtherModel();tools["switch-texture"].callback=()=>s.loadRandModel();if(!Array.isArray(i.tools)){i.tools=Object.keys(tools)}for(let e of i.tools){if(tools[e]){const{icon:t,callback:o}=tools[e];document.getElementById("waifu-tool").insertAdjacentHTML("beforeend",`<span id="waifu-tool-${e}">${t}</span>`);document.getElementById(`waifu-tool-${e}`).addEventListener("click",o)}}})();function a(o){if(location.pathname==="/"){for(let{hour:e,text:t}of o){const i=new Date,s=e.split("-")[0],n=e.split("-")[1]||s;if(s<=i.getHours()&&i.getHours()<=n){return t}}}const e=`欢迎阅读<span>「${document.title.split(" - ")[0]}」</span>`;let t;if(document.referrer!==""){const a=new URL(document.referrer),l=a.hostname.split(".")[1];const r={baidu:"百度",so:"360搜索",google:"谷歌搜索"};if(location.hostname===a.hostname)return e;if(l in r)t=r[l];else t=a.hostname;return`Hello！来自 <span>${t}</span> 的朋友<br>${e}`}return e}function n(i){let e=false,t,n=i.message.default,s;window.addEventListener("mousemove",()=>e=true);window.addEventListener("keydown",()=>e=true);setInterval(()=>{if(e){e=false;clearInterval(t);t=null}else if(!t){t=setInterval(()=>{showMessage(n,6e3,9)},2e4)}},1e3);showMessage(a(i.time),7e3,11);window.addEventListener("mouseover",o=>{for(let{selector:e,text:t}of i.mouseover){if(!o.target.closest(e))continue;if(s===e)return;s=e;t=randomSelection(t);t=t.replace("{text}",o.target.innerText);showMessage(t,4e3,8);return}});window.addEventListener("click",o=>{for(let{selector:e,text:t}of i.click){if(!o.target.closest(e))continue;t=randomSelection(t);t=t.replace("{text}",o.target.innerText);showMessage(t,4e3,8);return}});i.seasons.forEach(({date:e,text:t})=>{const o=new Date,i=e.split("-")[0],s=e.split("-")[1]||i;if(i.split("/")[0]<=o.getMonth()+1&&o.getMonth()+1<=s.split("/")[0]&&(i.split("/")[1]<=o.getDate()&&o.getDate()<=s.split("/")[1])){t=randomSelection(t);t=t.replace("{year}",o.getFullYear());n.push(t)}});const o=()=>{};console.log("%c",o);o.toString=()=>{showMessage(i.message.console,6e3,9)};window.addEventListener("copy",()=>{showMessage(i.message.copy,6e3,9)});window.addEventListener("visibilitychange",()=>{if(!document.hidden)showMessage(i.message.visibilitychange,6e3,9)})}(function e(){let t=localStorage.getItem("modelId"),o=localStorage.getItem("modelTexturesId");if(t===null){t=1;o=53}s.loadModel(t,o);fetch(i.waifuPath).then(e=>e.json()).then(n)})()}function initWidget(e,t){if(typeof e==="string"){e={waifuPath:e,apiPath:t}}document.body.insertAdjacentHTML("beforeend",`<div id="waifu-toggle">
            <span>看板娘</span>
        </div>`);const o=document.getElementById("waifu-toggle");o.addEventListener("click",()=>{o.classList.remove("waifu-toggle-active");if(o.getAttribute("first-time")){loadWidget(e);o.removeAttribute("first-time")}else{localStorage.removeItem("waifu-display");document.getElementById("waifu").style.display="";setTimeout(()=>{document.getElementById("waifu").style.bottom=0},0)}});if(localStorage.getItem("waifu-display")&&Date.now()-localStorage.getItem("waifu-display")<=864e5){o.setAttribute("first-time",true);setTimeout(()=>{o.classList.add("waifu-toggle-active")},0)}else{loadWidget(e)}}export default initWidget;